name: C/C++ CI

on:
  push:
  pull_request:

env:
  VCPKG_COMMIT: 1286cac8751e13bb289061b7e3b89eb4c3f613a2
  VCPKG_DIR: C:/deps/vcpkg
  VCPKG_TRIPLET: x64-windows-static
  CMAKE_PRESET: ninja-linux-vcpkg

jobs:
  job_build_cpp:
    name: ${{ matrix.os }}-${{ matrix.buildConfig }}
    runs-on: ${{ matrix.os }}

    steps:
    # Checkout
    - uses: actions/checkout@v2
      with:
        submodules: true
        fetch-depth: 0

    # Setup MSVC
    - uses: ilammy/msvc-dev-cmd@v1

    # Install latest CMake
    - uses: lukka/get-cmake@latest

    - name: Create folder
      run: |
        mkdir ${{ env.VCPKG_DIR }}

    # Setup vcpkg and build deps
    - name: Restore artifacts, or Run vcpkg, build and cache artifacts
      uses: lukka/run-vcpkg@v11
      id: runvcpkg
      with:
        vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }}
        vcpkgDirectory: ${{ env.VCPKG_DIR }}

    - name: Run CMake consuming CMakePresets.json and vcpkg.json by mean of vcpkg.
      uses: lukka/run-cmake@v10
      with:
        configurePreset: ${{ env.CMAKE_PRESET }}
        buildPreset: ${{ env.CMAKE_PRESET }}-release

    # Build the mod
    - uses: gruppe-adler/action-release-with-hemtt@v3
      name: 'Build Mod with HEMTT'
      id: build

    # Upload the mod
    - uses: actions/upload-artifact@v1
      with:
        name: ${{ steps.build.outputs.mod_name }}
        path: ${{ steps.build.outputs.release_path }}

    # zip it
    - uses: papeloto/action-zip@v1
      with:
        files: \@${{ steps.build.outputs.mod_name }}/
        dest: \@${{ steps.build.outputs.mod_name }}.zip

    # release it
    - uses: "marvinpinto/action-automatic-releases@latest"
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        prerelease: true
        files: |
          \@${{needs.job_build_cpp.outputs.modName}}.zip
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
